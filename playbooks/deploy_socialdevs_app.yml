---
- name: ‚®úÔ∏è Aplicar manifiesto de la app {{ app_name }} en ArgoCD
  hosts: localhost
  gather_facts: false
  become: false

  vars_files:
    - ../vars/main.yml

  vars:
    manifest_tmp: "/tmp/{{ app_name }}-bootstrap.yaml"

  tasks:
    - name: üìù Renderizar manifest de la aplicaci√≥n
      template:
        src: ../templates/bootstrap-application.yaml.j2
        dest: "{{ manifest_tmp }}"

    - name: üöÄ kubectl apply
      command: kubectl apply -f "{{ manifest_tmp }}"
      register: apply_out
      changed_when: "'created' in apply_out.stdout or 'configured' in apply_out.stdout"

    - name: ‚úÖ Verificar que la Application existe
      command: >
        kubectl -n {{ argo_namespace }} get application {{ app_name }} -o wide
      register: verify_out
      changed_when: false

    - name: ‚ÑπÔ∏è Mostrar estado
      debug:
        msg: "{{ verify_out.stdout }}"
